<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹å±±å®¶å…·å®šåˆ¶ - MongoDBæ•´åˆæŠ¥ä»·ç³»ç»Ÿï¼ˆé«˜çº§ç‰ˆï¼‰</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-text: #1d1d1f;
            --secondary-text: #86868b;
            --tertiary-text: #a1a1a6;
            --background: #ffffff;
            --surface: #f5f5f7;
            --card-background: #fbfbfd;
            --accent-blue: #007aff;
            --accent-blue-hover: #0056cc;
            --accent-green: #34c759;
            --accent-red: #ff3b30;
            --accent-orange: #ff9500;
            --border-light: #d2d2d7;
            --shadow-light: rgba(0, 0, 0, 0.04);
            --shadow-medium: rgba(0, 0, 0, 0.08);
            --shadow-heavy: rgba(0, 0, 0, 0.16);
            --radius-small: 8px;
            --radius-medium: 12px;
            --radius-large: 16px;
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
            --spacing-xl: 48px;
            --spacing-xxl: 64px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--primary-text);
            line-height: 1.47059;
            font-size: 17px;
            font-weight: 400;
            letter-spacing: -0.022em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            font-weight: 500;
        }

        .connection-status.connected { background: var(--accent-green); color: white; }
        .connection-status.disconnected { background: var(--accent-red); color: white; }
        .connection-status.loading { background: var(--accent-orange); color: white; }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hero Section */
        .hero {
            background: var(--background);
            padding: 88px var(--spacing-md) 64px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid var(--border-light);
        }

        .hero h1 {
            font-size: 56px;
            line-height: 1.07143;
            font-weight: 600;
            letter-spacing: -0.005em;
            color: var(--primary-text);
            margin-bottom: var(--spacing-sm);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .hero p {
            font-size: 21px;
            line-height: 1.381;
            font-weight: 400;
            letter-spacing: 0.011em;
            color: var(--secondary-text);
            max-width: 980px;
            margin: 0 auto;
        }

        .badge {
            display: inline-block;
            background: var(--accent-blue);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 max(var(--spacing-md), env(safe-area-inset-left));
        }

        /* Section */
        .section {
            padding: 88px 0;
            position: relative;
        }

        .section-title {
            font-size: 48px;
            line-height: 1.08349;
            font-weight: 600;
            letter-spacing: -0.003em;
            text-align: center;
            margin-bottom: 64px;
            color: var(--primary-text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 48px;
            padding: 4px;
            background: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 10px var(--shadow-light);
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: var(--secondary-text);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            white-space: nowrap;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab-btn:hover {
            background: rgba(0, 122, 255, 0.08);
            color: var(--accent-blue);
        }

        .tab-btn.active {
            background: var(--background);
            color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        /* Tab Content */
        .tab-content {
            position: relative;
            min-height: 400px;
        }

        .tab-panel {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculator-card {
            background: var(--card-background);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-large);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            box-shadow: 0 4px 20px var(--shadow-light);
        }

        .calculator-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--primary-text);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--primary-text);
            margin-bottom: var(--spacing-xs);
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-small);
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--background);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        /* Input Groups */
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            align-items: end;
        }

        .input-group-triple {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--spacing-sm);
            align-items: end;
        }

        .config-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--spacing-sm);
        }

        .config-item {
            display: flex;
            flex-direction: column;
        }

        .config-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--secondary-text);
            margin-bottom: 6px;
            text-align: center;
        }

        /* Advanced Settings */
        .advanced-settings {
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-medium);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .advanced-settings h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-text);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .toggle-advanced {
            background: var(--accent-orange);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--radius-small);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            margin-left: auto;
        }

        .dynamic-inputs {
            margin-top: var(--spacing-sm);
        }

        .dimension-group {
            margin-bottom: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--background);
            border-radius: var(--radius-small);
            border: 1px solid var(--border-light);
        }

        .dimension-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--primary-text);
            margin-bottom: var(--spacing-xs);
        }

        /* Material Selector with Search */
        .material-selector {
            position: relative;
        }

        .material-search {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-small);
            font-size: 1rem;
            background: var(--background);
            transition: all 0.3s ease;
            cursor: text;
        }
        
        .material-search:hover {
            border-color: var(--accent-blue);
        }

        .material-search:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .material-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--background);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-small);
            box-shadow: 0 8px 25px var(--shadow-medium);
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .material-dropdown.show {
            display: block;
        }

        .material-option {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--surface);
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .material-option:hover,
        .material-option.active {
            background: var(--surface);
        }
        
        .material-option.active {
            background: var(--accent-blue);
            color: white;
        }
        
        .material-option.active .material-name,
        .material-option.active .material-price {
            color: white;
        }

        .material-option:last-child {
            border-bottom: none;
        }
        
        .material-option.hidden {
            display: none;
        }
        
        .material-option .material-name {
            font-weight: 500;
            color: var(--primary-text);
        }
        
        .material-option .material-price {
            font-size: 0.9rem;
            color: var(--accent-green);
            font-weight: 600;
        }

        .material-option .name {
            font-weight: 500;
            color: var(--primary-text);
        }

        .material-option .price {
            font-size: 0.9rem;
            color: var(--accent-blue);
            font-weight: 600;
        }

        /* Calculation Info */
        .calculation-info {
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-medium);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .calculation-info h4 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--primary-text);
            margin-bottom: var(--spacing-xs);
        }

        .calculation-info p {
            font-size: 0.85rem;
            color: var(--secondary-text);
            line-height: 1.5;
            margin-bottom: 4px;
        }

        .separate-pricing {
            background: linear-gradient(90deg, var(--accent-blue), #5856d6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600 !important;
            margin-top: var(--spacing-xs) !important;
        }

        /* Buttons */
        .btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: var(--radius-small);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            width: 100%;
            margin-top: var(--spacing-md);
            letter-spacing: -0.01em;
        }

        .btn:hover {
            background: var(--accent-blue-hover);
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.3);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
            margin: 0;
        }

        .btn-danger {
            background: var(--accent-red);
        }

        .btn-danger:hover {
            background: #d70015;
        }

        .btn-success {
            background: var(--accent-green);
        }

        .btn-success:hover {
            background: #28a745;
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--primary-text);
            border: 2px solid var(--border-light);
        }

        .btn-secondary:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* Results Section */
        .results {
            background: var(--card-background);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-large);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-xl);
            box-shadow: 0 8px 30px var(--shadow-light);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .results h3 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--primary-text);
        }

        .results-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        /* Table */
        .quote-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--background);
            border-radius: var(--radius-medium);
            overflow: hidden;
            box-shadow: 0 4px 20px var(--shadow-light);
            margin-bottom: var(--spacing-lg);
        }

        .quote-table th {
            background: var(--surface);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary-text);
            border-bottom: 1px solid var(--border-light);
        }

        .quote-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            color: var(--primary-text);
        }

        .quote-table tr:hover {
            background: var(--surface);
        }

        .quote-table tr:last-child td {
            border-bottom: none;
        }

        .total-row {
            background: var(--accent-blue) !important;
            color: white !important;
        }

        .total-row td {
            font-weight: 600;
            border-bottom: none !important;
        }

        .total-summary {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-text);
            padding: var(--spacing-md);
            background: var(--surface);
            border-radius: var(--radius-medium);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .hero h1 { font-size: 28px; }
            .hero p { font-size: 16px; }
            .input-group, .input-group-triple, .config-inputs {
                grid-template-columns: 1fr;
            }
            .tab-navigation {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            .results-header {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div class="connection-status loading" id="connectionStatus">
        <span class="loading-spinner"></span>è¿æ¥MongoDBä¸­...
    </div>

    <div class="hero">
        <div class="badge">ğŸ”— MongoDBå®æ—¶æ•°æ®é©±åŠ¨</div>
        <h1>ä¹å±±å®¶å…·å®šåˆ¶</h1>
        <p>ä¸“ä¸šã€ç²¾å‡†ã€é«˜æ•ˆçš„å®šåˆ¶å®¶å…·æŠ¥ä»·è®¡ç®—ç³»ç»Ÿ - é«˜çº§ç®—æ³•æ•´åˆç‰ˆ</p>
    </div>

    <div class="container">
        <section class="section">
            <h2 class="section-title">é¡¹ç›®è®¡ç®—</h2>
            
            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="showTab('cabinet')">æŸœä½“</button>
                <button class="tab-btn" onclick="showTab('wallpanel')">å¢™æ¿</button>
                <button class="tab-btn" onclick="showTab('door')">å®¤å†…é—¨</button>
                <button class="tab-btn" onclick="showTab('stone')">çŸ³æå²©æ¿</button>
                <button class="tab-btn" onclick="showTab('island')">æ©±æŸœå²›å°</button>
                <button class="tab-btn" onclick="showTab('baseboard')">è¸¢è„šçº¿</button>
            </div>
            
            <!-- æ ‡ç­¾é¡µå†…å®¹ -->
            <div class="tab-content">
                <!-- æŸœä½“æ ‡ç­¾é¡µ - é«˜çº§ç‰ˆæœ¬ -->
                <div id="tab-cabinet" class="tab-panel active">
                    <div class="calculator-card">
                        <h3>æŸœä½“è®¡ç®—</h3>
                        
                        <div class="form-group">
                            <label>è®¡ç®—æ–¹å¼</label>
                            <select id="cabinetMethod" onchange="toggleCabinetMethod()">
                                <option value="auto">è‡ªåŠ¨è®¡ç®—å±•å¼€é¢ç§¯</option>
                                <option value="manual">ç›´æ¥è¾“å…¥å±•å¼€é¢ç§¯</option>
                            </select>
                        </div>
                        
                        <div id="autoDimensions">
                            <div class="form-group">
                                <label>é¡¹ç›®åç§°</label>
                                <input type="text" id="cabinetName" placeholder="ä¾‹å¦‚: å®¢å…ç”µè§†æŸœ">
                            </div>
                            
                            <div class="form-group">
                                <label>æŸœä½“å°ºå¯¸ (mm)</label>
                                <div class="input-group-triple">
                                    <div>
                                        <label>é«˜åº¦ (mm)</label>
                                        <input type="number" id="cabinetHeight" placeholder="é«˜åº¦" step="1" min="0">
                                    </div>
                                    <div>
                                        <label>å®½åº¦ (mm)</label>
                                        <input type="number" id="cabinetWidth" placeholder="å®½åº¦" step="1" min="0">
                                    </div>
                                    <div>
                                        <label>æ·±åº¦ (mm)</label>
                                        <input type="number" id="cabinetDepth" placeholder="æ·±åº¦" step="1" min="0">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>æŸœä½“é…ç½®</label>
                                <div class="config-inputs">
                                    <div class="config-item">
                                        <label class="config-label">é—¨æ¿æ•°é‡</label>
                                        <input type="number" id="cabinetDoors" placeholder="2" min="0" value="2">
                                    </div>
                                    <div class="config-item">
                                        <label class="config-label">æ¨ªéš”æ¿æ•°é‡</label>
                                        <input type="number" id="cabinetShelves" placeholder="1" min="0" value="1">
                                    </div>
                                    <div class="config-item">
                                        <label class="config-label">ç«–éš”æ¿æ•°é‡</label>
                                        <input type="number" id="cabinetVerticalShelves" placeholder="0" min="0" value="0">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>æŸœé—¨ç±»å‹</label>
                                <select id="doorCoverageType" onchange="toggleDoorCoverage()">
                                    <option value="full">å…¨è¦†ç›–ï¼ˆæŒ‰æŸœä½“å°ºå¯¸ï¼‰</option>
                                    <option value="custom">éå…¨è¦†ç›–ï¼ˆè‡ªå®šä¹‰å°ºå¯¸ï¼‰</option>
                                </select>
                            </div>
                            
                            <div id="customDoorDimensions" style="display: none;">
                                <div class="form-group">
                                    <label>å•æ‰‡é—¨æ¿å°ºå¯¸ (mm)</label>
                                    <div class="input-group">
                                        <div>
                                            <label>é—¨é«˜ (mm)</label>
                                            <input type="number" id="doorHeight" placeholder="é—¨é«˜" step="1" min="0">
                                        </div>
                                        <div>
                                            <label>é—¨å®½ (mm)</label>
                                            <input type="number" id="doorWidth" placeholder="é—¨å®½" step="1" min="0">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- é«˜çº§è®¾ç½® -->
                            <div class="advanced-settings">
                                <h4>
                                    é«˜çº§è®¾ç½® 
                                    <button class="toggle-advanced" onclick="toggleAdvancedSettings()">å±•å¼€</button>
                                </h4>
                                
                                <div id="advancedOptions" style="display: none;">
                                    <!-- ç»ç’ƒé—¨æ›¿æ¢è®¾ç½® -->
                                    <div class="form-group">
                                        <label>ç»ç’ƒé—¨æ›¿æ¢è®¾ç½®</label>
                                        <div class="input-group">
                                            <div>
                                                <label class="config-label">ç»ç’ƒé—¨æ•°é‡</label>
                                                <input type="number" id="glassDoorCount" placeholder="0" min="0" value="0" onchange="toggleGlassDoorSettings()">
                                            </div>
                                            <div>
                                                <label>ç»ç’ƒæè´¨</label>
                                                <div class="material-selector">
                                                    <input type="text" class="material-search" id="glassMaterialSearch" 
                                                           placeholder="æœç´¢ç»ç’ƒç±»å‹..." onclick="showMaterialOptions('glass')" 
                                                           onkeyup="filterMaterials('glass', this.value)" 
                                                           onfocus="showMaterialOptions('glass')">
                                                    <div class="material-dropdown" id="glassMaterialDropdown"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="glassDoorSettings" style="display: none;">
                                        <div class="form-group">
                                            <label>ç»ç’ƒé—¨å°ºå¯¸è®¾ç½® (mm)</label>
                                            <div id="glassDoorDimensions" class="dynamic-inputs">
                                                <!-- åŠ¨æ€ç”Ÿæˆçš„ç»ç’ƒé—¨å°ºå¯¸è¾“å…¥æ¡† -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- é•‚ç©ºå¼€æ”¾æ ¼è®¾ç½® -->
                                    <div class="form-group">
                                        <label>é•‚ç©ºå¼€æ”¾æ ¼è®¾ç½®</label>
                                        <div class="config-item">
                                            <label class="config-label">å¼€æ”¾æ ¼æ•°é‡</label>
                                            <input type="number" id="openSpaceCount" placeholder="0" min="0" value="0" onchange="toggleOpenSpaceSettings()">
                                        </div>
                                    </div>
                                    
                                    <div id="openSpaceSettings" style="display: none;">
                                        <div class="form-group">
                                            <label>å¼€æ”¾æ ¼å°ºå¯¸è®¾ç½® (cm)</label>
                                            <div id="openSpaceDimensions" class="dynamic-inputs">
                                                <!-- åŠ¨æ€ç”Ÿæˆçš„å¼€æ”¾æ ¼å°ºå¯¸è¾“å…¥æ¡† -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="calculation-info">
                                <h4>ğŸ’¡ è®¡ç®—å…¬å¼</h4>
                                <p><strong>æŸœä½“é¢ç§¯</strong> = é¡¶æ¿ + åº•æ¿ + å·¦å³ä¾§æ¿ + èƒŒæ¿ + æ¨ªéš”æ¿ + ç«–éš”æ¿</p>
                                <p>æŸœä½“: 2Ã—(å®½Ã—æ·±) + 2Ã—(æ·±Ã—é«˜) + (å®½Ã—é«˜) + æ¨ªéš”æ¿Ã—(å®½Ã—æ·±) + ç«–éš”æ¿Ã—(æ·±Ã—é«˜)</p>
                                <p><strong>æŸœé—¨æ€»é¢ç§¯</strong>:</p>
                                <p>â€¢ å…¨è¦†ç›–: æŸœä½“æ€»å®½Ã—æŸœä½“æ€»é«˜</p>
                                <p>â€¢ éå…¨è¦†ç›–: æŸœé—¨æ€»å®½Ã—æŸœé—¨æ€»é«˜</p>
                                <p><strong>é“°é“¾è®¡ç®—</strong>: æ¯æ‰‡é—¨é…1å¥—é“°é“¾ï¼Œæ¯å¥—é“°é“¾ä¸ªæ•° = âŒŠé—¨é«˜/50âŒ‹ + 1</p>
                                <p><strong>æ‹‰æ‰‹è®¡ç®—</strong>: æ‹‰æ‰‹æ•°é‡ = é—¨æ¿æ•°é‡</p>
                                <p><strong>æ»‘è½¨è®¡ç®—</strong>: ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥æ»‘è½¨æ•°é‡</p>
                                <p class="separate-pricing">ğŸ¯ æŸœé—¨æŒ‰æ€»é¢ç§¯æŠ¥ä»·ï¼Œé“°é“¾å’Œæ‹‰æ‰‹æŒ‰é—¨æ•°è®¡ç®—ï¼Œæ»‘è½¨æŒ‰ç”¨æˆ·æŒ‡å®šæ•°é‡</p>
                            </div>
                        </div>
                        
                        <div id="manualDimensions" style="display: none;">
                            <div class="form-group">
                                <label>é¡¹ç›®åç§°</label>
                                <input type="text" id="cabinetNameManual" placeholder="ä¾‹å¦‚: å®¢å…ç”µè§†æŸœ">
                            </div>
                            <div class="form-group">
                                <label>å±•å¼€é¢ç§¯ (ã¡)</label>
                                <input type="number" id="cabinetArea" step="0.01" placeholder="ç›´æ¥è¾“å…¥å±•å¼€é¢ç§¯" min="0">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>æè´¨ä»·æ ¼è®¾ç½®</label>
                            <div class="input-group-triple">
                                <div>
                                    <label>æŸœä½“æ¿æå‹å·</label>
                                    <div class="material-selector">
                                        <input type="text" class="material-search" id="cabinetMaterialSearch" 
                                               placeholder="æœç´¢æŸœä½“æè´¨..." onclick="showMaterialOptions('cabinet')" 
                                               onkeyup="filterMaterials('cabinet', this.value)" 
                                               onfocus="showMaterialOptions('cabinet')">
                                        <div class="material-dropdown" id="cabinetMaterialDropdown"></div>
                                    </div>
                                </div>
                                <div>
                                    <label>æŸœé—¨æ¿æå‹å·</label>
                                    <div class="material-selector">
                                        <input type="text" class="material-search" id="doorPanelMaterialSearch" 
                                               placeholder="æœç´¢é—¨æ¿æè´¨..." onclick="showMaterialOptions('doorPanel')" 
                                               onkeyup="filterMaterials('doorPanel', this.value)" 
                                               onfocus="showMaterialOptions('doorPanel')">
                                        <div class="material-dropdown" id="doorPanelMaterialDropdown"></div>
                                    </div>
                                </div>
                                <div>
                                    <label>é“°é“¾å‹å·</label>
                                    <div class="material-selector">
                                        <input type="text" class="material-search" id="hingeMaterialSearch" 
                                               placeholder="æœç´¢é“°é“¾ç±»å‹..." onclick="showMaterialOptions('hinge')" 
                                               onkeyup="filterMaterials('hinge', this.value)" 
                                               onfocus="showMaterialOptions('hinge')">
                                        <div class="material-dropdown" id="hingeMaterialDropdown"></div>
                                    </div>
                                </div>
                                <div>
                                    <label>æ‹‰æ‰‹å‹å·</label>
                                    <div class="material-selector">
                                        <input type="text" class="material-search" id="handleMaterialSearch" 
                                               placeholder="æœç´¢æ‹‰æ‰‹ç±»å‹..." onclick="showMaterialOptions('handle')" 
                                               onkeyup="filterMaterials('handle', this.value)" 
                                               onfocus="showMaterialOptions('handle')">
                                        <div class="material-dropdown" id="handleMaterialDropdown"></div>
                                    </div>
                                </div>
                                <div>
                                    <label>æ»‘è½¨å‹å·</label>
                                    <div class="material-selector">
                                        <input type="text" class="material-search" id="slideMaterialSearch" 
                                               placeholder="æœç´¢æ»‘è½¨ç±»å‹..." onclick="showMaterialOptions('slide')" 
                                               onkeyup="filterMaterials('slide', this.value)" 
                                               onfocus="showMaterialOptions('slide')">
                                        <div class="material-dropdown" id="slideMaterialDropdown"></div>
                                    </div>
                                </div>
                                <div>
                                    <label>æ»‘è½¨æ•°é‡</label>
                                    <input type="number" id="slideCount" min="0" step="1" value="0" placeholder="æ»‘è½¨å¥—æ•°">
                                </div>
                                <div>
                                    <label>ç½—é©¬æŸ±å‹å·</label>
                                    <div class="material-selector">
                                        <input type="text" class="material-search" id="columnMaterialSearch" 
                                               placeholder="æœç´¢ç½—é©¬æŸ±ç±»å‹..." onclick="showMaterialOptions('column')" 
                                               onkeyup="filterMaterials('column', this.value)" 
                                               onfocus="showMaterialOptions('column')">
                                        <div class="material-dropdown" id="columnMaterialDropdown"></div>
                                    </div>
                                </div>
                                <div>
                                    <label>ç½—é©¬æŸ±é•¿åº¦ (mm)</label>
                                    <input type="number" id="columnLength" min="0" step="1" value="0" placeholder="ç½—é©¬æŸ±é•¿åº¦">
                                </div>
                                <div>
                                    <label>ç¯å…‰å‹å·</label>
                                    <div class="material-selector">
                                        <input type="text" class="material-search" id="lightingMaterialSearch" 
                                               placeholder="æœç´¢ç¯å…‰ç±»å‹..." onclick="showMaterialOptions('lighting')" 
                                               onkeyup="filterMaterials('lighting', this.value)" 
                                               onfocus="showMaterialOptions('lighting')">
                                        <div class="material-dropdown" id="lightingMaterialDropdown"></div>
                                    </div>
                                </div>
                                <div>
                                    <label>ç¯å…‰é•¿åº¦ (mm)</label>
                                    <input type="number" id="lightingLength" min="0" step="1" value="0" placeholder="ç¯å…‰é•¿åº¦">
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn" onclick="addCabinetAdvanced()">æ·»åŠ æŸœä½“é¡¹ç›®</button>
                    </div>
                </div>
                
                <!-- å…¶ä»–æ ‡ç­¾é¡µä¿æŒç®€åŒ–ç‰ˆæœ¬ -->
                <div id="tab-wallpanel" class="tab-panel">
                    <div class="calculator-card">
                        <h3>å¢™æ¿è®¡ç®—</h3>
                        
                        <div class="form-group">
                            <label>é¡¹ç›®åç§°</label>
                            <input type="text" id="wallpanelName" placeholder="ä¾‹å¦‚: å®¢å…èƒŒæ™¯å¢™">
                        </div>
                        
                        <div class="form-group">
                            <label>å¢™æ¿å°ºå¯¸ (mm)</label>
                            <div class="input-group">
                                <div>
                                    <label>é«˜åº¦ (mm)</label>
                                    <input type="number" id="wallpanelHeight" placeholder="é«˜åº¦" step="1" min="0">
                                </div>
                                <div>
                                    <label>å®½åº¦ (mm)</label>
                                    <input type="number" id="wallpanelWidth" placeholder="å®½åº¦" step="1" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>å¢™æ¿æè´¨</label>
                            <div class="material-selector">
                                <input type="text" class="material-search" id="wallpanelMaterialSearch" 
                                       placeholder="æœç´¢å¢™æ¿æè´¨..." onclick="showMaterialOptions('wallpanel')" 
                                       onkeyup="filterMaterials('wallpanel', this.value)" 
                                       onfocus="showMaterialOptions('wallpanel')">
                                <div class="material-dropdown" id="wallpanelMaterialDropdown"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>ç½—é©¬æŸ±å‹å·</label>
                            <div class="material-selector">
                                <input type="text" class="material-search" id="wallpanelColumnMaterialSearch" 
                                       placeholder="æœç´¢ç½—é©¬æŸ±ç±»å‹..." onclick="showMaterialOptions('column', 'wallpanelColumnMaterialDropdown')" 
                                       onkeyup="filterMaterials('column', this.value, 'wallpanelColumnMaterialDropdown')" 
                                       onfocus="showMaterialOptions('column', 'wallpanelColumnMaterialDropdown')">
                                <div class="material-dropdown" id="wallpanelColumnMaterialDropdown"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>ç½—é©¬æŸ±é•¿åº¦ (mm)</label>
                            <input type="number" id="wallpanelColumnLength" min="0" step="1" value="0" placeholder="ç½—é©¬æŸ±é•¿åº¦">
                        </div>
                        
                        <div class="form-group">
                            <label>ç¯å…‰å‹å·</label>
                            <div class="material-selector">
                                <input type="text" class="material-search" id="wallpanelLightingMaterialSearch" 
                                       placeholder="æœç´¢ç¯å…‰ç±»å‹..." onclick="showMaterialOptions('lighting', 'wallpanelLightingMaterialDropdown')" 
                                       onkeyup="filterMaterials('lighting', this.value, 'wallpanelLightingMaterialDropdown')" 
                                       onfocus="showMaterialOptions('lighting', 'wallpanelLightingMaterialDropdown')">
                                <div class="material-dropdown" id="wallpanelLightingMaterialDropdown"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>ç¯å…‰é•¿åº¦ (mm)</label>
                            <input type="number" id="wallpanelLightingLength" min="0" step="1" value="0" placeholder="ç¯å…‰é•¿åº¦">
                        </div>
                        
                        <button class="btn" onclick="addWallpanelAdvanced()">æ·»åŠ å¢™æ¿é¡¹ç›®</button>
                    </div>
                </div>
                
                <!-- å…¶ä»–æ ‡ç­¾é¡µå†…å®¹... (ä¿æŒç®€åŒ–ï¼Œé‡ç‚¹åœ¨æŸœä½“) -->
                <div id="tab-door" class="tab-panel">
                    <div class="calculator-card">
                        <h3>å®¤å†…é—¨è®¡ç®—</h3>
                        <div class="form-group">
                            <label>é¡¹ç›®åç§°</label>
                            <input type="text" id="doorName" placeholder="ä¾‹å¦‚: å§å®¤é—¨">
                        </div>
                        <div class="form-group">
                            <label>é—¨æ•°é‡ (æ¨˜)</label>
                            <input type="number" id="doorQuantity" placeholder="æ•°é‡" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label>é—¨ç±»å‹</label>
                            <div class="material-selector">
                                <input type="text" class="material-search" id="doorMaterialSearch" 
                                       placeholder="æœç´¢é—¨ç±»å‹..." onclick="showMaterialOptions('door')" 
                                       onkeyup="filterMaterials('door', this.value)" 
                                       onfocus="showMaterialOptions('door')">
                                <div class="material-dropdown" id="doorMaterialDropdown"></div>
                            </div>
                        </div>
                        <button class="btn" onclick="addItem('door')">æ·»åŠ å®¤å†…é—¨é¡¹ç›®</button>
                    </div>
                </div>
                
                <!-- ç®€åŒ–çš„å…¶ä»–æ ‡ç­¾é¡µ -->
                
                <div id="tab-stone" class="tab-panel">
                    <div class="calculator-card">
                        <h3>çŸ³æå²©æ¿è®¡ç®—</h3>
                        <div class="form-group">
                            <label>é¡¹ç›®åç§°</label>
                            <input type="text" id="stoneName" placeholder="ä¾‹å¦‚: å®¢å…åœ°é¢çŸ³æ">
                        </div>
                        <div class="form-group">
                            <label>é¢ç§¯ (ã¡)</label>
                            <input type="number" id="stoneArea" placeholder="é¢ç§¯" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>çŸ³æç±»å‹</label>
                            <div class="material-selector">
                                <input type="text" class="material-search" id="stoneMaterialSearch" 
                                       placeholder="æœç´¢çŸ³æç±»å‹..." onclick="showMaterialOptions('stone')" 
                                       onkeyup="filterMaterials('stone', this.value)" 
                                       onfocus="showMaterialOptions('stone')">
                                <div class="material-dropdown" id="stoneMaterialDropdown"></div>
                            </div>
                        </div>
                        <button class="btn" onclick="addItem('stone')">æ·»åŠ çŸ³æé¡¹ç›®</button>
                    </div>
                </div>
                
                <div id="tab-island" class="tab-panel">
                    <div class="calculator-card">
                        <h3>æ©±æŸœå²›å°è®¡ç®—</h3>
                        <div class="form-group">
                            <label>é¡¹ç›®åç§°</label>
                            <input type="text" id="islandName" placeholder="ä¾‹å¦‚: å¨æˆ¿ä¸­å²›">
                        </div>
                        <div class="form-group">
                            <label>é•¿åº¦ (mm)</label>
                            <input type="number" id="islandLength" placeholder="é•¿åº¦" step="1" min="0">
                        </div>
                        <div class="form-group">
                            <label>å²›å°ç±»å‹</label>
                            <div class="material-selector">
                                <input type="text" class="material-search" id="islandMaterialSearch" 
                                       placeholder="æœç´¢å²›å°ç±»å‹..." onclick="showMaterialOptions('island')" 
                                       onkeyup="filterMaterials('island', this.value)" 
                                       onfocus="showMaterialOptions('island')">
                                <div class="material-dropdown" id="islandMaterialDropdown"></div>
                            </div>
                        </div>
                        <button class="btn" onclick="addItem('island')">æ·»åŠ å²›å°é¡¹ç›®</button>
                    </div>
                </div>
                
                <div id="tab-baseboard" class="tab-panel">
                    <div class="calculator-card">
                        <h3>è¸¢è„šçº¿è®¡ç®—</h3>
                        <div class="form-group">
                            <label>é¡¹ç›®åç§°</label>
                            <input type="text" id="baseboardName" placeholder="ä¾‹å¦‚: å®¢å…è¸¢è„šçº¿">
                        </div>
                        <div class="form-group">
                            <label>é•¿åº¦ (mm)</label>
                            <input type="number" id="baseboardLength" placeholder="é•¿åº¦" step="1" min="0">
                        </div>
                        <div class="form-group">
                            <label>è¸¢è„šçº¿ç±»å‹</label>
                            <div class="material-selector">
                                <input type="text" class="material-search" id="baseboardMaterialSearch" 
                                       placeholder="æœç´¢è¸¢è„šçº¿ç±»å‹..." onclick="showMaterialOptions('baseboard')" 
                                       onkeyup="filterMaterials('baseboard', this.value)" 
                                       onfocus="showMaterialOptions('baseboard')">
                                <div class="material-dropdown" id="baseboardMaterialDropdown"></div>
                            </div>
                        </div>
                        <button class="btn" onclick="addItem('baseboard')">æ·»åŠ è¸¢è„šçº¿é¡¹ç›®</button>
                    </div>
                </div>
                
            </div>
        </section>

        <section class="section">
            <div class="results fade-in">
                <div class="results-header">
                    <h3>ğŸ“‹ é¡¹ç›®æŠ¥ä»·æ¸…å•</h3>
                    <div class="results-actions">
                        <button class="btn-secondary btn-small" onclick="clearAllItems()">æ¸…ç©ºæ¸…å•</button>
                        <button class="btn-success btn-small" onclick="exportToExcel()">å¯¼å‡ºExcel</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="quote-table" id="quoteTable">
                        <thead>
                            <tr>
                                <th>åºå·</th>
                                <th>ç©ºé—´äº§å“å</th>
                                <th>ç±»å‹</th>
                                <th>æè´¨è§„æ ¼</th>
                                <th>æ•°é‡/é¢ç§¯</th>
                                <th>å•ä»·</th>
                                <th>å°è®¡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="quoteBody">
                            <!-- æŠ¥ä»·é¡¹ç›®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </tbody>
                    </table>
                </div>
                
                <div class="total-summary">
                    æ€»è®¡é‡‘é¢: Â¥<span id="totalAmount">0.00</span>
                </div>
            </div>
        </section>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let quoteItems = [];
        let itemCounter = 0;
        let selectedMaterials = {};
        let materialDatabase = {}; // å°†ä»MongoDBåŠ è½½
        let isMongoDBConnected = false; // MongoDBè¿æ¥çŠ¶æ€

        // è¿æ¥çŠ¶æ€ç®¡ç†
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            if (isMongoDBConnected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = 'âœ… MongoDBå·²è¿æ¥';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = 'âŒ ä½¿ç”¨å¤‡ç”¨æ•°æ®';
            }
        }

        // æ–°å¢ï¼šä»MongoDBåŠ è½½ææ–™æ•°æ®
        async function loadMaterialsFromMongoDB() {
            try {
                const response = await fetch('/api/prices');
                const result = await response.json();
                if (result.success) {
                    materialDatabase = result.data.reduce((acc, item) => {
                        if (!acc[item.category]) {
                            acc[item.category] = [];
                        }
                        acc[item.category].push(item);
                        return acc;
                    }, {});
                    console.log('ææ–™æ•°æ®ä»MongoDBåŠ è½½æˆåŠŸ:', materialDatabase);
                    isMongoDBConnected = true;
                } else {
                    console.error('ä»MongoDBåŠ è½½ææ–™å¤±è´¥:', result.error);
                    isMongoDBConnected = false;
                    loadFallbackData();
                }
            } catch (error) {
                console.error('è¿æ¥åˆ°åç«¯APIå¤±è´¥:', error);
                isMongoDBConnected = false;
                loadFallbackData();
            }
            updateConnectionStatus();
        }

        // å¤‡ç”¨æ•°æ®
        function loadFallbackData() {
            materialDatabase = {
                cabinet: [
                    { id: 'cab_001', name: 'æ ‡å‡†å¯†åº¦æ¿ 18mm', brand: 'ä¹å±±å®¶å…·', price: 280, unit: 'å…ƒ/ã¡' },
                    { id: 'cab_002', name: 'é«˜å¯†åº¦æ¿ 18mm', brand: 'ä¹å±±å®¶å…·', price: 320, unit: 'å…ƒ/ã¡' },
                    { id: 'cab_003', name: 'å®æœ¨é¢—ç²’æ¿ 18mm', brand: 'ä¹å±±å®¶å…·', price: 350, unit: 'å…ƒ/ã¡' }
                ],
                doorPanel: [
                    { id: 'door_001', name: 'æ ‡å‡†é—¨æ¿ å…æ¼†', brand: 'ä¹å±±å®¶å…·', price: 320, unit: 'å…ƒ/ã¡' },
                    { id: 'door_002', name: 'å¸å¡‘é—¨æ¿ PVC', brand: 'ä¹å±±å®¶å…·', price: 380, unit: 'å…ƒ/ã¡' }
                ],
                hardware: [
                    // é“°é“¾
                    { id: 'hinge_001', name: 'æ ‡å‡†é“°é“¾ å†·è½§é’¢', brand: 'ä¹å±±å®¶å…·', price: 25, unit: 'å…ƒ/ä¸ª', category: 'é“°é“¾' },
                    { id: 'hinge_002', name: 'ç¼“å†²é“°é“¾ æ¶²å‹', brand: 'ä¹å±±å®¶å…·', price: 35, unit: 'å…ƒ/ä¸ª', category: 'é“°é“¾' },
                    { id: 'hinge_003', name: 'é˜»å°¼é“°é“¾ é™éŸ³', brand: 'ä¹å±±å®¶å…·', price: 45, unit: 'å…ƒ/ä¸ª', category: 'é“°é“¾' },
                    // æ‹‰æ‰‹
                    { id: 'handle_001', name: 'æ ‡å‡†æ‹‰æ‰‹ ä¸é”ˆé’¢', brand: 'ä¹å±±å®¶å…·', price: 15, unit: 'å…ƒ/ä¸ª', category: 'æ‹‰æ‰‹' },
                    { id: 'handle_002', name: 'æ¬§å¼æ‹‰æ‰‹ é“œè´¨', brand: 'ä¹å±±å®¶å…·', price: 25, unit: 'å…ƒ/ä¸ª', category: 'æ‹‰æ‰‹' },
                    { id: 'handle_003', name: 'ç°ä»£æ‹‰æ‰‹ é“åˆé‡‘', brand: 'ä¹å±±å®¶å…·', price: 20, unit: 'å…ƒ/ä¸ª', category: 'æ‹‰æ‰‹' },
                    // æ»‘è½¨
                    { id: 'slide_001', name: 'æ ‡å‡†æ»‘è½¨ ä¸‰èŠ‚', brand: 'ä¹å±±å®¶å…·', price: 35, unit: 'å…ƒ/å¥—', category: 'æ»‘è½¨' },
                    { id: 'slide_002', name: 'ç¼“å†²æ»‘è½¨ é˜»å°¼', brand: 'ä¹å±±å®¶å…·', price: 55, unit: 'å…ƒ/å¥—', category: 'æ»‘è½¨' },
                    { id: 'slide_003', name: 'é‡å‹æ»‘è½¨ æ‰¿é‡', brand: 'ä¹å±±å®¶å…·', price: 75, unit: 'å…ƒ/å¥—', category: 'æ»‘è½¨' }
                ],
                glass: [
                    { id: 'glass_001', name: 'é€æ˜é’¢åŒ–ç»ç’ƒ 5mm', brand: 'ä¹å±±å®¶å…·', price: 120, unit: 'å…ƒ/ã¡' },
                    { id: 'glass_002', name: 'ç£¨ç ‚ç»ç’ƒ 6mm', brand: 'ä¹å±±å®¶å…·', price: 150, unit: 'å…ƒ/ã¡' }
                ],
                wallpanel: [
                    { id: 'wall_001', name: 'æ ‡å‡†æŠ¤å¢™æ¿ å®æœ¨', brand: 'ä¹å±±å®¶å…·', price: 380, unit: 'å…ƒ/ã¡' }
                ],
                door: [
                    { id: 'door_001', name: 'æ ‡å‡†å®¤å†…é—¨ å…æ¼†', brand: 'ä¹å±±å®¶å…·', price: 1200, unit: 'å…ƒ/æ¨˜' }
                ],
                column: [
                    { id: 'col_001', name: 'æ¬§å¼ç½—é©¬æŸ± çŸ³è†', brand: 'ä¹å±±å®¶å…·', price: 280, unit: 'å…ƒ/ç±³' }
                ],
                lighting: [
                    { id: 'light_001', name: 'LEDç¯å¸¦ æš–ç™½', brand: 'ä¹å±±å®¶å…·', price: 25, unit: 'å…ƒ/ç±³' }
                ],
                stone: [
                    { id: 'stone_001', name: 'å¤©ç„¶å¤§ç†çŸ³', brand: 'ä¹å±±å®¶å…·', price: 680, unit: 'å…ƒ/ã¡' }
                ],
                island: [
                    { id: 'island_001', name: 'æ ‡å‡†æ©±æŸœå²›å°', brand: 'ä¹å±±å®¶å…·', price: 1200, unit: 'å…ƒ/å»¶ç±³' }
                ],
                baseboard: [
                    { id: 'base_001', name: 'æ ‡å‡†è¸¢è„šçº¿ PVC', brand: 'ä¹å±±å®¶å…·', price: 35, unit: 'å…ƒ/ç±³' }
                ]
            };
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function showTab(tabName) {
            console.log('åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:', tabName);
            
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            const tabPanels = document.querySelectorAll('.tab-panel');
            tabPanels.forEach(panel => {
                panel.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            const selectedPanel = document.getElementById('tab-' + tabName);
            if (selectedPanel) {
                selectedPanel.classList.add('active');
                console.log('æ ‡ç­¾é¡µåˆ‡æ¢æˆåŠŸ:', tabName);
            } else {
                console.error('æ‰¾ä¸åˆ°æ ‡ç­¾é¡µ:', 'tab-' + tabName);
            }
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
            const clickedButton = event.target;
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            // éšè—æ‰€æœ‰ææ–™ä¸‹æ‹‰èœå•
            hideAllMaterialDropdowns();
        }

        // åˆ‡æ¢æŸœä½“è®¡ç®—æ–¹å¼
        function toggleCabinetMethod() {
            const method = document.getElementById('cabinetMethod').value;
            const autoDimensions = document.getElementById('autoDimensions');
            const manualDimensions = document.getElementById('manualDimensions');
            
            if (method === 'auto') {
                autoDimensions.style.display = 'block';
                manualDimensions.style.display = 'none';
            } else {
                autoDimensions.style.display = 'none';
                manualDimensions.style.display = 'block';
            }
        }

        // åˆ‡æ¢é—¨è¦†ç›–æ¨¡å¼
        function toggleDoorCoverage() {
            const coverageType = document.getElementById('doorCoverageType').value;
            const customDoorDimensions = document.getElementById('customDoorDimensions');
            
            if (coverageType === 'custom') {
                customDoorDimensions.style.display = 'block';
            } else {
                customDoorDimensions.style.display = 'none';
            }
        }

        // åˆ‡æ¢é«˜çº§è®¾ç½®
        function toggleAdvancedSettings() {
            const advancedOptions = document.getElementById('advancedOptions');
            const toggleButton = document.querySelector('.toggle-advanced');
            
            if (advancedOptions.style.display === 'none' || !advancedOptions.style.display) {
                advancedOptions.style.display = 'block';
                toggleButton.textContent = 'æ”¶èµ·';
            } else {
                advancedOptions.style.display = 'none';
                toggleButton.textContent = 'å±•å¼€';
            }
        }

        // åˆ‡æ¢ç»ç’ƒé—¨è®¾ç½®
        function toggleGlassDoorSettings() {
            const glassDoorCount = parseInt(document.getElementById('glassDoorCount').value) || 0;
            const glassDoorSettings = document.getElementById('glassDoorSettings');
            
            if (glassDoorCount > 0) {
                glassDoorSettings.style.display = 'block';
                generateGlassDoorDimensions(glassDoorCount);
            } else {
                glassDoorSettings.style.display = 'none';
            }
        }

        // åˆ‡æ¢å¼€æ”¾æ ¼è®¾ç½®
        function toggleOpenSpaceSettings() {
            const openSpaceCount = parseInt(document.getElementById('openSpaceCount').value) || 0;
            const openSpaceSettings = document.getElementById('openSpaceSettings');
            
            if (openSpaceCount > 0) {
                openSpaceSettings.style.display = 'block';
                generateOpenSpaceDimensions(openSpaceCount);
            } else {
                openSpaceSettings.style.display = 'none';
            }
        }

        // åŠ¨æ€ç”Ÿæˆç»ç’ƒé—¨å°ºå¯¸è¾“å…¥æ¡†
        function generateGlassDoorDimensions(count) {
            const container = document.getElementById('glassDoorDimensions');
            const currentCount = container.children.length;
            
            if (count > currentCount) {
                // å¢åŠ è¾“å…¥æ¡†
                for (let i = currentCount + 1; i <= count; i++) {
                    const dimensionGroup = document.createElement('div');
                    dimensionGroup.className = 'dimension-group';
                    dimensionGroup.innerHTML = `
                        <div class="dimension-label">ç¬¬${i}æ‰‡ç»ç’ƒé—¨</div>
                        <div class="input-group">
                            <div>
                                <label>é«˜åº¦ (mm)</label>
                                <input type="number" id="glassDoorHeight${i}" placeholder="é«˜åº¦" step="1" min="0">
                            </div>
                            <div>
                                <label>å®½åº¦ (mm)</label>
                                <input type="number" id="glassDoorWidth${i}" placeholder="å®½åº¦" step="1" min="0">
                            </div>
                        </div>
                    `;
                    container.appendChild(dimensionGroup);
                }
            } else if (count < currentCount) {
                // å‡å°‘è¾“å…¥æ¡†
                for (let i = currentCount; i > count; i--) {
                    const lastGroup = container.lastElementChild;
                    if (lastGroup) {
                        container.removeChild(lastGroup);
                    }
                }
            }
        }

        // åŠ¨æ€ç”Ÿæˆå¼€æ”¾æ ¼å°ºå¯¸è¾“å…¥æ¡†
        function generateOpenSpaceDimensions(count) {
            const container = document.getElementById('openSpaceDimensions');
            const currentCount = container.children.length;
            
            if (count > currentCount) {
                // å¢åŠ è¾“å…¥æ¡†
                for (let i = currentCount + 1; i <= count; i++) {
                    const dimensionGroup = document.createElement('div');
                    dimensionGroup.className = 'dimension-group';
                    dimensionGroup.innerHTML = `
                        <div class="dimension-label">ç¬¬${i}ä¸ªå¼€æ”¾æ ¼</div>
                        <div class="input-group">
                            <div>
                                <label>é«˜åº¦ (mm)</label>
                                <input type="number" id="openSpaceHeight${i}" placeholder="é«˜åº¦" step="1" min="0">
                            </div>
                            <div>
                                <label>å®½åº¦ (mm)</label>
                                <input type="number" id="openSpaceWidth${i}" placeholder="å®½åº¦" step="1" min="0">
                            </div>
                        </div>
                    `;
                    container.appendChild(dimensionGroup);
                }
            } else if (count < currentCount) {
                // å‡å°‘è¾“å…¥æ¡†
                for (let i = currentCount; i > count; i--) {
                    const lastGroup = container.lastElementChild;
                    if (lastGroup) {
                        container.removeChild(lastGroup);
                    }
                }
            }
        }

        // è®¡ç®—æŸœä½“å±•å¼€é¢ç§¯ï¼ˆä¸åŒ…æ‹¬é—¨æ¿ï¼‰
        function calculateCabinetArea(height, width, depth, horizontalShelves, verticalShelves) {
            // è½¬æ¢ä¸ºç±³ (è¾“å…¥å·²ç»æ˜¯ç±³ï¼Œæ— éœ€è½¬æ¢)
            const h = height;
            const w = width;
            const d = depth;
            
            // æŸœä½“é¢ç§¯è®¡ç®—ï¼ˆä¸åŒ…æ‹¬é—¨æ¿ï¼‰
            const topBottom = 2 * (w * d);                    // é¡¶æ¿+åº•æ¿
            const leftRight = 2 * (d * h);                    // å·¦å³ä¾§æ¿
            const back = w * h;                               // èƒŒæ¿
            const horizontalShelvesArea = horizontalShelves * (w * d); // æ¨ªéš”æ¿
            const verticalShelvesArea = verticalShelves * (d * h);     // ç«–éš”æ¿
            
            return topBottom + leftRight + back + horizontalShelvesArea + verticalShelvesArea;
        }

        // è®¡ç®—æŸœé—¨æ€»é¢ç§¯
        function calculateDoorTotalArea(width, height, doors, coverageType, doorWidth, doorHeight) {
            if (coverageType === 'full') {
                // å…¨è¦†ç›–æ¨¡å¼ï¼šæŸœé—¨æ€»é¢ç§¯ = æŸœä½“æ€»é«˜ Ã— æŸœä½“æ€»å®½
                const w = width; // å·²ç»æ˜¯ç±³ï¼Œæ— éœ€è½¬æ¢
                const h = height; // å·²ç»æ˜¯ç±³ï¼Œæ— éœ€è½¬æ¢
                return w * h;
            } else {
                // éå…¨è¦†ç›–æ¨¡å¼ï¼šæŸœé—¨æ€»é¢ç§¯ = æŸœé—¨æ€»å®½ Ã— æŸœé—¨æ€»é«˜
                const dw = doorWidth; // å·²ç»æ˜¯ç±³ï¼Œæ— éœ€è½¬æ¢
                const dh = doorHeight; // å·²ç»æ˜¯ç±³ï¼Œæ— éœ€è½¬æ¢
                return dw * dh;
            }
        }

        // è®¡ç®—é“°é“¾æ•°é‡ï¼ˆæ¯æ‰‡é—¨ä¸€å¥—ï¼Œæ¯å¥—é“°é“¾ä¸ªæ•°æŒ‰é—¨é«˜è®¡ç®—ï¼‰
        function calculateHinges(doors, doorHeight, coverageType, cabinetHeight) {
            if (doors === 0) return 0;
            
            let actualDoorHeight;
            if (coverageType === 'full') {
                actualDoorHeight = cabinetHeight;
            } else {
                actualDoorHeight = doorHeight;
            }
            
            // æ¯å¥—é“°é“¾ä¸ªæ•° = âŒŠé—¨é«˜/0.5âŒ‹ + 1 (é—¨é«˜æ˜¯ç±³ï¼Œ500mm=0.5m)
            const hingesPerSet = Math.floor(actualDoorHeight / 0.5) + 1;
            // æ€»é“°é“¾ä¸ªæ•° = é—¨æ•° Ã— æ¯å¥—é“°é“¾ä¸ªæ•°
            return doors * hingesPerSet;
        }

        // è®¡ç®—æ‹‰æ‰‹æ•°é‡ï¼ˆæ‹‰æ‰‹æ•°é‡ = é—¨æ¿æ•°é‡ï¼‰
        function calculateHandles(doors) {
            return doors;
        }

        // è®¡ç®—æ»‘è½¨æ•°é‡ï¼ˆæ»‘è½¨æ•°é‡ = é—¨æ¿æ•°é‡ï¼‰
        function calculateSlides(doors) {
            return doors;
        }

        // é«˜çº§æŸœä½“è®¡ç®—åŠŸèƒ½
        function addCabinetAdvanced() {
            console.log('æ·»åŠ é«˜çº§æŸœä½“é¡¹ç›®');
            
            const method = document.getElementById('cabinetMethod').value;
            const name = method === 'auto' ? 
                (document.getElementById('cabinetName').value || 'æŸœä½“é¡¹ç›®') : 
                (document.getElementById('cabinetNameManual').value || 'æŸœä½“é¡¹ç›®');
            
            // è·å–ææ–™
            const cabinetMaterial = selectedMaterials['cabinet'];
            const doorPanelMaterial = selectedMaterials['doorPanel'];
            const hingeMaterial = selectedMaterials['hinge'];
            
            if (!cabinetMaterial) {
                alert('è¯·é€‰æ‹©æŸœä½“æè´¨ï¼');
                return;
            }
            
            if (method === 'auto') {
                const height = parseFloat(document.getElementById('cabinetHeight').value) / 1000; // mmè½¬m
                const width = parseFloat(document.getElementById('cabinetWidth').value) / 1000; // mmè½¬m
                const depth = parseFloat(document.getElementById('cabinetDepth').value) / 1000; // mmè½¬m
                const doors = parseInt(document.getElementById('cabinetDoors').value) || 0;
                const horizontalShelves = parseInt(document.getElementById('cabinetShelves').value) || 0;
                const verticalShelves = parseInt(document.getElementById('cabinetVerticalShelves').value) || 0;
                const coverageType = document.getElementById('doorCoverageType').value;
                
                if (!height || !width || !depth) {
                    alert('è¯·è¾“å…¥å®Œæ•´çš„æŸœä½“å°ºå¯¸ï¼');
                    return;
                }
                
                // è®¡ç®—æŸœä½“é¢ç§¯ï¼ˆä¸å«é—¨æ¿ï¼‰
                const cabinetArea = calculateCabinetArea(height, width, depth, horizontalShelves, verticalShelves);
                const cabinetSubtotal = cabinetArea * cabinetMaterial.price;
                const cabinetDetails = `${(height*1000).toFixed(0)}Ã—${(width*1000).toFixed(0)}Ã—${(depth*1000).toFixed(0)}mm, æ¨ªéš”æ¿${horizontalShelves}ä¸ª, ç«–éš”æ¿${verticalShelves}ä¸ª`;
                
                // æ·»åŠ æŸœä½“é¡¹ç›®
                quoteItems.push({
                    id: ++itemCounter,
                    name: name + ' - æŸœä½“',
                    type: 'æŸœä½“',
                    material: cabinetMaterial.name,
                    quantity: cabinetArea.toFixed(2) + ' ã¡',
                    details: cabinetDetails,
                    unitPrice: cabinetMaterial.price,
                    subtotal: cabinetSubtotal
                });
                
                // è·å–ç»ç’ƒé—¨å’Œå¼€æ”¾æ ¼ä¿¡æ¯
                const glassDoorCount = parseInt(document.getElementById('glassDoorCount').value) || 0;
                const openSpaceCount = parseInt(document.getElementById('openSpaceCount').value) || 0;
                
                // å¦‚æœæœ‰é—¨æ¿ï¼Œæ·»åŠ é—¨æ¿é¡¹ç›®å’Œé“°é“¾é¡¹ç›®
                if (doors > 0) {
                    if (!doorPanelMaterial) {
                        alert('è¯·é€‰æ‹©æŸœé—¨æ¿æï¼');
                        return;
                    }
                    
                    let doorTotalArea, doorDetails, actualDoorHeight;
                    
                    if (coverageType === 'full') {
                        // å…¨è¦†ç›–æ¨¡å¼ï¼šæŸœé—¨æ€»é¢ç§¯ = æŸœä½“æ€»å®½ Ã— æŸœä½“æ€»é«˜
                        doorTotalArea = calculateDoorTotalArea(width, height, doors, 'full');
                        doorDetails = `å…¨è¦†ç›–: ${(width*1000).toFixed(0)}Ã—${(height*1000).toFixed(0)}mm (æŸœä½“æ€»é¢ç§¯)`;
                        actualDoorHeight = height;
                    } else {
                        // éå…¨è¦†ç›–æ¨¡å¼ï¼šæŸœé—¨æ€»é¢ç§¯ = å•æ‰‡é—¨é«˜ Ã— å•æ‰‡é—¨å®½ Ã— é—¨æ¿æ•°é‡
                        const doorWidth = parseFloat(document.getElementById('doorWidth').value) / 1000; // mmè½¬m
                        const doorHeight = parseFloat(document.getElementById('doorHeight').value) / 1000; // mmè½¬m
                        
                        if (!doorWidth || !doorHeight) {
                            alert('è¯·è¾“å…¥å®Œæ•´çš„å•æ‰‡é—¨æ¿å°ºå¯¸ï¼');
                            return;
                        }
                        
                        doorTotalArea = calculateDoorTotalArea(0, 0, doors, 'custom', doorWidth, doorHeight);
                        doorDetails = `éå…¨è¦†ç›–: ${(doorWidth*1000).toFixed(0)}Ã—${(doorHeight*1000).toFixed(0)}mm (æŸœé—¨æ€»é¢ç§¯)`;
                        actualDoorHeight = doorHeight;
                    }
                    
                    // å‡å»å¼€æ”¾æ ¼é¢ç§¯
                    if (openSpaceCount > 0) {
                        let totalOpenSpaceArea = 0;
                        let openSpaceDetails = [];
                        
                        for (let i = 1; i <= openSpaceCount; i++) {
                            const height = parseFloat(document.getElementById(`openSpaceHeight${i}`).value) / 1000 || 0; // mmè½¬m
                            const width = parseFloat(document.getElementById(`openSpaceWidth${i}`).value) / 1000 || 0; // mmè½¬m
                            if (height > 0 && width > 0) {
                                const area = height * width; // å·²ç»æ˜¯å¹³æ–¹ç±³
                                totalOpenSpaceArea += area;
                                openSpaceDetails.push(`${(width*1000).toFixed(0)}Ã—${(height*1000).toFixed(0)}mm`);
                            }
                        }
                        
                        if (totalOpenSpaceArea > 0) {
                            doorTotalArea = Math.max(0, doorTotalArea - totalOpenSpaceArea);
                            doorDetails += `, å‡å»${openSpaceCount}ä¸ªå¼€æ”¾æ ¼(${openSpaceDetails.join(', ')})`;
                        }
                    }
                    
                    const doorSubtotal = doorTotalArea * doorPanelMaterial.price;
                    
                    // æ·»åŠ æŸœé—¨é¡¹ç›®
                    quoteItems.push({
                        id: ++itemCounter,
                        name: name + ' - æŸœé—¨',
                        type: 'æŸœé—¨',
                        material: doorPanelMaterial.name,
                        quantity: doorTotalArea.toFixed(2) + ' ã¡',
                        details: doorDetails,
                        unitPrice: doorPanelMaterial.price,
                        subtotal: doorSubtotal
                    });
                    
                    // è®¡ç®—å¹¶æ·»åŠ é“°é“¾é¡¹ç›®
                    if (hingeMaterial) {
                        const totalHinges = calculateHinges(doors, actualDoorHeight, coverageType, height);
                        const hingesPerSet = Math.floor(actualDoorHeight / 0.5) + 1;
                        const hingeSubtotal = totalHinges * hingeMaterial.price;
                        const hingeDetails = `${doors}æ‰‡é—¨Ã—${hingesPerSet}ä¸ª/æ‰‡ (é—¨é«˜${(actualDoorHeight*1000).toFixed(0)}mm)`;
                        
                        quoteItems.push({
                            id: ++itemCounter,
                            name: name + ' - é“°é“¾',
                            type: 'é“°é“¾',
                            material: hingeMaterial.name,
                            quantity: totalHinges + ' ä¸ª',
                            details: hingeDetails,
                            unitPrice: hingeMaterial.price,
                            subtotal: hingeSubtotal
                        });
                    }
                    
                    // è®¡ç®—å¹¶æ·»åŠ æ‹‰æ‰‹é¡¹ç›®
                    const handleMaterial = selectedMaterials['handle'];
                    if (handleMaterial) {
                        const totalHandles = calculateHandles(doors);
                        const handleSubtotal = totalHandles * handleMaterial.price;
                        const handleDetails = `${doors}æ‰‡é—¨ï¼Œæ¯æ‰‡é—¨1ä¸ªæ‹‰æ‰‹`;
                        
                        quoteItems.push({
                            id: ++itemCounter,
                            name: name + ' - æ‹‰æ‰‹',
                            type: 'æ‹‰æ‰‹',
                            material: handleMaterial.name,
                            quantity: totalHandles + ' ä¸ª',
                            details: handleDetails,
                            unitPrice: handleMaterial.price,
                            subtotal: handleSubtotal
                        });
                    }
                    
                    // è®¡ç®—å¹¶æ·»åŠ æ»‘è½¨é¡¹ç›®
                    const slideMaterial = selectedMaterials['slide'];
                    if (slideMaterial) {
                        const slideCount = parseInt(document.getElementById('slideCount').value) || 0;
                        if (slideCount > 0) {
                            const slideSubtotal = slideCount * slideMaterial.price;
                            const slideDetails = `ç”¨æˆ·æŒ‡å®šæ•°é‡: ${slideCount}å¥—æ»‘è½¨`;
                            
                            quoteItems.push({
                                id: ++itemCounter,
                                name: name + ' - æ»‘è½¨',
                                type: 'æ»‘è½¨',
                                material: slideMaterial.name,
                                quantity: slideCount + ' å¥—',
                                details: slideDetails,
                                unitPrice: slideMaterial.price,
                                subtotal: slideSubtotal
                            });
                        }
                    }
                }
                
                // å¦‚æœæœ‰ç»ç’ƒé—¨æ›¿æ¢ï¼Œæ·»åŠ ç»ç’ƒé—¨å·®ä»·é¡¹ç›®
                if (glassDoorCount > 0) {
                    const glassMaterial = selectedMaterials['glass'];
                    
                    if (glassMaterial) {
                        let glassTotalArea = 0;
                        let glassDetails = [];
                        
                        // è®¡ç®—æ¯æ‰‡ç»ç’ƒé—¨çš„é¢ç§¯
                        for (let i = 1; i <= glassDoorCount; i++) {
                            const glassHeight = (parseFloat(document.getElementById(`glassDoorHeight${i}`).value) / 1000) || actualDoorHeight; // mmè½¬m
                            const glassWidth = (parseFloat(document.getElementById(`glassDoorWidth${i}`).value) / 1000) || (width / doors); // mmè½¬m
                            if (glassHeight > 0 && glassWidth > 0) {
                                const area = glassHeight * glassWidth; // å·²ç»æ˜¯å¹³æ–¹ç±³
                                glassTotalArea += area;
                                glassDetails.push(`${(glassWidth*1000).toFixed(0)}Ã—${(glassHeight*1000).toFixed(0)}mm`);
                            }
                        }
                        
                        if (glassTotalArea > 0) {
                            const glassSubtotal = glassTotalArea * glassMaterial.price;
                            const glassDetailsStr = `ç»ç’ƒé—¨æ›¿æ¢: ${glassDoorCount}æ‰‡(${glassDetails.join(', ')})`;
                            
                            quoteItems.push({
                                id: ++itemCounter,
                                name: name + ' - ç»ç’ƒé—¨',
                                type: 'ç»ç’ƒé—¨',
                                material: glassMaterial.name,
                                quantity: glassTotalArea.toFixed(2) + ' ã¡',
                                details: glassDetailsStr,
                                unitPrice: glassMaterial.price,
                                subtotal: glassSubtotal
                            });
                            
                            // è®¡ç®—é—¨æ¿å·®ä»·ï¼ˆå‡å»æ›¿æ¢çš„é—¨æ¿é¢ç§¯è´¹ç”¨ï¼‰
                            if (doorPanelMaterial) {
                                const doorPriceDifference = glassTotalArea * doorPanelMaterial.price;
                                
                                if (doorPriceDifference > 0) {
                                    quoteItems.push({
                                        id: ++itemCounter,
                                        name: name + ' - é—¨æ¿å‡é¡¹',
                                        type: 'å‡é¡¹',
                                        material: doorPanelMaterial.name,
                                        quantity: glassTotalArea.toFixed(2) + ' ã¡',
                                        details: `ç»ç’ƒé—¨æ›¿æ¢å‡å»é—¨æ¿: ${glassDoorCount}æ‰‡`,
                                        unitPrice: -doorPanelMaterial.price,
                                        subtotal: -doorPriceDifference
                                    });
                                }
                            }
                        }
                    }
                }
            } else {
                // æ‰‹åŠ¨è¾“å…¥æ¨¡å¼
                const area = parseFloat(document.getElementById('cabinetArea').value);
                if (!area) {
                    alert('è¯·è¾“å…¥å±•å¼€é¢ç§¯ï¼');
                    return;
                }
                
                const subtotal = area * cabinetMaterial.price;
                
                quoteItems.push({
                    id: ++itemCounter,
                    name: name,
                    type: 'æŸœä½“',
                    material: cabinetMaterial.name,
                    quantity: area.toFixed(2) + ' ã¡',
                    details: 'æ‰‹åŠ¨è¾“å…¥',
                    unitPrice: cabinetMaterial.price,
                    subtotal: subtotal
                });
            }
            
            // è®¡ç®—å¹¶æ·»åŠ ç½—é©¬æŸ±é¡¹ç›®
            const columnMaterial = selectedMaterials['column'];
            if (columnMaterial) {
                const columnLength = parseFloat(document.getElementById('columnLength').value) / 1000 || 0; // mmè½¬m
                if (columnLength > 0) {
                    const columnSubtotal = columnLength * columnMaterial.price;
                    const columnDetails = `é•¿åº¦: ${columnLength.toFixed(2)}ç±³`;
                    
                    quoteItems.push({
                        id: ++itemCounter,
                        name: name + ' - ç½—é©¬æŸ±',
                        type: 'ç½—é©¬æŸ±',
                        material: columnMaterial.name,
                        quantity: columnLength + ' ç±³',
                        details: columnDetails,
                        unitPrice: columnMaterial.price,
                        subtotal: columnSubtotal
                    });
                }
            }
            
            // è®¡ç®—å¹¶æ·»åŠ ç¯å…‰é¡¹ç›®
            const lightingMaterial = selectedMaterials['lighting'];
            if (lightingMaterial) {
                const lightingLength = parseFloat(document.getElementById('lightingLength').value) / 1000 || 0; // mmè½¬m
                if (lightingLength > 0) {
                    const lightingSubtotal = lightingLength * lightingMaterial.price;
                    const lightingDetails = `é•¿åº¦: ${lightingLength.toFixed(2)}ç±³`;
                    
                    quoteItems.push({
                        id: ++itemCounter,
                        name: name + ' - ç¯å…‰',
                        type: 'ç¯å…‰',
                        material: lightingMaterial.name,
                        quantity: lightingLength + ' ç±³',
                        details: lightingDetails,
                        unitPrice: lightingMaterial.price,
                        subtotal: lightingSubtotal
                    });
                }
            }
            
            updateQuoteTable();
            clearCabinetInputs();
            
            console.log('é«˜çº§æŸœä½“é¡¹ç›®æ·»åŠ å®Œæˆ');
        }

        // é«˜çº§å¢™æ¿è®¡ç®—åŠŸèƒ½
        function addWallpanelAdvanced() {
            console.log('æ·»åŠ é«˜çº§å¢™æ¿é¡¹ç›®');
            
            const name = document.getElementById('wallpanelName').value || 'å¢™æ¿é¡¹ç›®';
            const wallpanelMaterial = selectedMaterials['wallpanel'];
            
            if (!wallpanelMaterial) {
                alert('è¯·é€‰æ‹©å¢™æ¿æè´¨ï¼');
                return;
            }
            
            const height = parseFloat(document.getElementById('wallpanelHeight').value) / 1000; // mmè½¬m
            const width = parseFloat(document.getElementById('wallpanelWidth').value) / 1000; // mmè½¬m
            
            if (!height || !width) {
                alert('è¯·è¾“å…¥å®Œæ•´çš„å¢™æ¿å°ºå¯¸ï¼');
                return;
            }
            
            const area = height * width; // å·²ç»æ˜¯å¹³æ–¹ç±³
            const subtotal = area * wallpanelMaterial.price;
            const details = `${(height*1000).toFixed(0)}Ã—${(width*1000).toFixed(0)}mm`;
            
            quoteItems.push({
                id: ++itemCounter,
                name: name + ' - å¢™æ¿',
                type: 'å¢™æ¿',
                material: wallpanelMaterial.name,
                quantity: area.toFixed(2) + ' ã¡',
                details: details,
                unitPrice: wallpanelMaterial.price,
                subtotal: subtotal
            });
            
            // è®¡ç®—å¹¶æ·»åŠ ç½—é©¬æŸ±é¡¹ç›®
            const columnMaterial = selectedMaterials['column'];
            if (columnMaterial) {
                const columnLength = parseFloat(document.getElementById('wallpanelColumnLength').value) / 1000 || 0; // mmè½¬m
                if (columnLength > 0) {
                    const columnSubtotal = columnLength * columnMaterial.price;
                    const columnDetails = `é•¿åº¦: ${columnLength.toFixed(2)}ç±³`;
                    
                    quoteItems.push({
                        id: ++itemCounter,
                        name: name + ' - ç½—é©¬æŸ±',
                        type: 'ç½—é©¬æŸ±',
                        material: columnMaterial.name,
                        quantity: columnLength + ' ç±³',
                        details: columnDetails,
                        unitPrice: columnMaterial.price,
                        subtotal: columnSubtotal
                    });
                }
            }
            
            // è®¡ç®—å¹¶æ·»åŠ ç¯å…‰é¡¹ç›®
            const lightingMaterial = selectedMaterials['lighting'];
            if (lightingMaterial) {
                const lightingLength = parseFloat(document.getElementById('wallpanelLightingLength').value) / 1000 || 0; // mmè½¬m
                if (lightingLength > 0) {
                    const lightingSubtotal = lightingLength * lightingMaterial.price;
                    const lightingDetails = `é•¿åº¦: ${lightingLength.toFixed(2)}ç±³`;
                    
                    quoteItems.push({
                        id: ++itemCounter,
                        name: name + ' - ç¯å…‰',
                        type: 'ç¯å…‰',
                        material: lightingMaterial.name,
                        quantity: lightingLength + ' ç±³',
                        details: lightingDetails,
                        unitPrice: lightingMaterial.price,
                        subtotal: lightingSubtotal
                    });
                }
            }
            
            updateQuoteTable();
            clearWallpanelInputs();
            
            console.log('é«˜çº§å¢™æ¿é¡¹ç›®æ·»åŠ å®Œæˆ');
        }

        // æ˜¾ç¤ºææ–™é€‰é¡¹
        function showMaterialOptions(type, customDropdownId = null) {
            hideAllMaterialDropdowns();
            
            // å¤„ç†æè´¨ç±»å‹æ˜ å°„ - ä½¿ç”¨æ–°çš„åˆ†ç±»
            let materialType = type;
            if (type === 'handle') {
                materialType = 'puller'; // æ‹‰æ‰‹ä½¿ç”¨pulleråˆ†ç±»
            } else if (type === 'hinge') {
                materialType = 'hinge'; // é“°é“¾ä½¿ç”¨hingeåˆ†ç±»
            } else if (type === 'slide') {
                materialType = 'railway'; // æ»‘è½¨ä½¿ç”¨railwayåˆ†ç±»
            }
            const dropdownId = customDropdownId || (type + 'MaterialDropdown');
            const dropdown = document.getElementById(dropdownId);
            const materials = materialDatabase[materialType] || [];
            
            if (!dropdown) {
                console.error('æ‰¾ä¸åˆ°ä¸‹æ‹‰èœå•å…ƒç´ :', type + 'MaterialDropdown');
                return;
            }
            
            // è·å–å½“å‰æœç´¢è¯
            const searchInput = document.getElementById(type + 'MaterialSearch');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            dropdown.innerHTML = '';
            
            if (materials.length === 0) {
                dropdown.innerHTML = '<div class="material-option" style="color: var(--secondary-text); text-align: center;">æš‚æ— æ•°æ®</div>';
            } else {
            materials.forEach(material => {
                const option = document.createElement('div');
                option.className = 'material-option';
                option.onclick = () => selectMaterial(type, material);
                    
                    // é«˜äº®æœç´¢è¯
                    let displayName = material.name;
                    if (searchTerm && material.name.toLowerCase().includes(searchTerm)) {
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        displayName = material.name.replace(regex, '<mark style="background: #ffeb3b; padding: 1px 2px; border-radius: 2px;">$1</mark>');
                    }
                    
                option.innerHTML = `
                        <div class="material-name">${displayName}</div>
                        <div class="material-price">Â¥${material.price}${material.unit.replace('å…ƒ', '')}</div>
                `;
                dropdown.appendChild(option);
            });
            }
            
            dropdown.style.display = 'block';
            dropdown.classList.add('show');
        }

        // é€‰æ‹©ææ–™
        function selectMaterial(type, material) {
            selectedMaterials[type] = material;
            const searchInput = document.getElementById(type + 'MaterialSearch');
            if (searchInput) {
                searchInput.value = `${material.name} - Â¥${material.price}${material.unit.replace('å…ƒ', '')}`;
            } else {
                console.error('æ‰¾ä¸åˆ°ææ–™è¾“å…¥æ¡†:', type + 'MaterialSearch');
            }
            hideAllMaterialDropdowns();
        }
        
        // æ·»åŠ é”®ç›˜äº‹ä»¶å¤„ç†
        function addKeyboardSupport() {
            document.addEventListener('keydown', function(e) {
                // å¦‚æœæŒ‰ä¸‹Escapeé”®ï¼Œéšè—æ‰€æœ‰ä¸‹æ‹‰èœå•
                if (e.key === 'Escape') {
                    hideAllMaterialDropdowns();
                }
            });
            
            // ä¸ºæ¯ä¸ªæè´¨æœç´¢æ¡†æ·»åŠ é”®ç›˜äº‹ä»¶
            document.querySelectorAll('.material-search').forEach(input => {
                input.addEventListener('keydown', function(e) {
                    const dropdown = this.nextElementSibling;
                    if (!dropdown || dropdown.style.display === 'none') return;
                    
                    const options = dropdown.querySelectorAll('.material-option');
                    if (options.length === 0) return;
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        const currentActive = dropdown.querySelector('.material-option.active');
                        if (currentActive) {
                            currentActive.classList.remove('active');
                            const next = currentActive.nextElementSibling;
                            if (next) {
                                next.classList.add('active');
                                next.scrollIntoView({ block: 'nearest' });
                            }
                        } else {
                            options[0].classList.add('active');
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        const currentActive = dropdown.querySelector('.material-option.active');
                        if (currentActive) {
                            currentActive.classList.remove('active');
                            const prev = currentActive.previousElementSibling;
                            if (prev) {
                                prev.classList.add('active');
                                prev.scrollIntoView({ block: 'nearest' });
                            }
                        } else {
                            options[options.length - 1].classList.add('active');
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        const activeOption = dropdown.querySelector('.material-option.active');
                        if (activeOption) {
                            activeOption.click();
                        }
                    }
                });
            });
        }

        // è¿‡æ»¤ææ–™
        function filterMaterials(type, searchTerm, customDropdownId = null) {
            // å¤„ç†æè´¨ç±»å‹æ˜ å°„ - ä½¿ç”¨æ–°çš„åˆ†ç±»
            let materialType = type;
            if (type === 'handle') {
                materialType = 'puller'; // æ‹‰æ‰‹ä½¿ç”¨pulleråˆ†ç±»
            } else if (type === 'hinge') {
                materialType = 'hinge'; // é“°é“¾ä½¿ç”¨hingeåˆ†ç±»
            } else if (type === 'slide') {
                materialType = 'railway'; // æ»‘è½¨ä½¿ç”¨railwayåˆ†ç±»
            }
            const dropdownId = customDropdownId || (type + 'MaterialDropdown');
            const dropdown = document.getElementById(dropdownId);
            const materials = materialDatabase[materialType] || [];
            
            if (!dropdown) {
                console.error('æ‰¾ä¸åˆ°ä¸‹æ‹‰èœå•å…ƒç´ :', type + 'MaterialDropdown');
                return;
            }
            
            // ç¡®ä¿ä¸‹æ‹‰èœå•æ˜¾ç¤º
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                dropdown.classList.add('show');
            }
            
            if (!searchTerm || searchTerm.trim() === '') {
                showMaterialOptions(type);
                return;
            }
            
            const searchLower = searchTerm.toLowerCase();
            const filteredMaterials = materials.filter(material => 
                material.name.toLowerCase().includes(searchLower) ||
                material.brand.toLowerCase().includes(searchLower)
            );
            
            dropdown.innerHTML = '';
            
            if (filteredMaterials.length === 0) {
                dropdown.innerHTML = '<div class="material-option" style="color: var(--secondary-text); text-align: center;">æœªæ‰¾åˆ°åŒ¹é…çš„æè´¨</div>';
            } else {
            filteredMaterials.forEach(material => {
                const option = document.createElement('div');
                option.className = 'material-option';
                option.onclick = () => selectMaterial(type, material);
                    
                    // é«˜äº®æœç´¢è¯
                    let displayName = material.name;
                    if (searchLower && material.name.toLowerCase().includes(searchLower)) {
                        const regex = new RegExp(`(${searchLower})`, 'gi');
                        displayName = material.name.replace(regex, '<mark style="background: #ffeb3b; padding: 1px 2px; border-radius: 2px;">$1</mark>');
                    }
                    
                option.innerHTML = `
                        <div class="material-name">${displayName}</div>
                        <div class="material-price">Â¥${material.price}${material.unit.replace('å…ƒ', '')}</div>
                `;
                dropdown.appendChild(option);
            });
            }
        }

        // éšè—æ‰€æœ‰ææ–™ä¸‹æ‹‰èœå•
        function hideAllMaterialDropdowns() {
            document.querySelectorAll('.material-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
                dropdown.classList.remove('show');
            });
        }

        // ç®€åŒ–ç‰ˆæ·»åŠ é¡¹ç›®åŠŸèƒ½ï¼ˆç”¨äºå…¶ä»–æ ‡ç­¾é¡µï¼‰
        function addItem(type) {
            console.log('æ·»åŠ é¡¹ç›®:', type);
            
            const nameInput = document.getElementById(type + 'Name');
            const material = selectedMaterials[type];
            
            if (!nameInput) {
                console.error('æ‰¾ä¸åˆ°é¡¹ç›®åç§°è¾“å…¥æ¡†:', type);
                return;
            }
            
            if (!material) {
                alert('è¯·é€‰æ‹©æè´¨ï¼');
                return;
            }
            
            const quantity = calculateQuantity(type);
            if (!quantity || quantity.value <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å°ºå¯¸æˆ–æ•°é‡ï¼');
                return;
            }
            
            const name = nameInput.value || (type + 'é¡¹ç›®');
            const unitPrice = material.price;
            const subtotal = quantity.value * unitPrice;
            
            // æ·»åŠ åˆ°æŠ¥ä»·æ¸…å•
            quoteItems.push({
                id: ++itemCounter,
                name: name,
                type: getTypeDisplayName(type),
                material: material.name,
                quantity: quantity.value.toFixed(2) + ' ' + quantity.unit,
                details: quantity.details,
                unitPrice: unitPrice,
                subtotal: subtotal
            });
            
            // æ›´æ–°æŠ¥ä»·è¡¨æ ¼
            updateQuoteTable();
            
            // æ¸…ç©ºè¾“å…¥
            clearInputs(type);
            
            console.log('é¡¹ç›®æ·»åŠ æˆåŠŸ:', name);
        }

        // è®¡ç®—é¢ç§¯æˆ–æ•°é‡
        function calculateQuantity(type) {
            switch (type) {
                case 'wallpanel':
                    const wallHeight = parseFloat(document.getElementById('wallpanelHeight').value) || 0;
                    const wallWidth = parseFloat(document.getElementById('wallpanelWidth').value) || 0;
                    if (wallHeight && wallWidth) {
                        const area = (wallHeight * wallWidth) / 10000; // è½¬æ¢ä¸ºå¹³æ–¹ç±³
                        return { value: area, unit: 'ã¡', details: `${wallHeight}Ã—${wallWidth}cm` };
                    }
                    return null;
                    
                case 'door':
                    const quantity = parseInt(document.getElementById('doorQuantity').value) || 1;
                    return { value: quantity, unit: 'æ¨˜', details: '' };
                    
                case 'column':
                    const columnLength = parseFloat(document.getElementById('columnLength').value) || 0;
                    return columnLength > 0 ? { value: columnLength, unit: 'ç±³', details: '' } : null;
                    
                case 'lighting':
                    const lightingLength = parseFloat(document.getElementById('lightingLength').value) || 0;
                    return lightingLength > 0 ? { value: lightingLength, unit: 'ç±³', details: '' } : null;
                    
                case 'stone':
                    const stoneArea = parseFloat(document.getElementById('stoneArea').value) || 0;
                    return stoneArea > 0 ? { value: stoneArea, unit: 'ã¡', details: '' } : null;
                    
                case 'island':
                    const islandLength = parseFloat(document.getElementById('islandLength').value) / 1000 || 0; // mmè½¬m
                    return islandLength > 0 ? { value: islandLength, unit: 'å»¶ç±³', details: '' } : null;
                    
                case 'baseboard':
                    const baseboardLength = parseFloat(document.getElementById('baseboardLength').value) / 1000 || 0; // mmè½¬m
                    return baseboardLength > 0 ? { value: baseboardLength, unit: 'ç±³', details: '' } : null;
                    
                default:
                    return null;
            }
        }

        // è·å–ç±»å‹æ˜¾ç¤ºåç§°
        function getTypeDisplayName(type) {
            const typeNames = {
                cabinet: 'æŸœä½“',
                wallpanel: 'å¢™æ¿',
                door: 'å®¤å†…é—¨',
                column: 'ç½—é©¬æŸ±',
                lighting: 'ç¯å…‰',
                stone: 'çŸ³æå²©æ¿',
                island: 'æ©±æŸœå²›å°',
                baseboard: 'è¸¢è„šçº¿'
            };
            return typeNames[type] || type;
        }

        // æ¸…ç©ºæŸœä½“è¾“å…¥
        function clearCabinetInputs() {
            const method = document.getElementById('cabinetMethod').value;
            
            if (method === 'auto') {
                ['cabinetName', 'cabinetHeight', 'cabinetWidth', 'cabinetDepth', 
                 'doorWidth', 'doorHeight', 'glassDoorCount', 'openSpaceCount', 'slideCount', 'columnLength', 'lightingLength'].forEach(id => {
                    const input = document.getElementById(id);
                    if (input) input.value = '';
                });
                
                document.getElementById('cabinetDoors').value = '2';
                document.getElementById('cabinetShelves').value = '1';
                document.getElementById('cabinetVerticalShelves').value = '0';
                document.getElementById('glassDoorCount').value = '0';
                document.getElementById('openSpaceCount').value = '0';
                
                // éšè—é«˜çº§è®¾ç½®
                document.getElementById('glassDoorSettings').style.display = 'none';
                document.getElementById('openSpaceSettings').style.display = 'none';
                document.getElementById('glassDoorDimensions').innerHTML = '';
                document.getElementById('openSpaceDimensions').innerHTML = '';
            } else {
                ['cabinetNameManual', 'cabinetArea'].forEach(id => {
                    const input = document.getElementById(id);
                    if (input) input.value = '';
                });
            }
            
            // æ¸…ç©ºææ–™é€‰æ‹©
            ['cabinetMaterialSearch', 'doorPanelMaterialSearch', 'hingeMaterialSearch', 'handleMaterialSearch', 'slideMaterialSearch', 'glassMaterialSearch', 'columnMaterialSearch', 'lightingMaterialSearch'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = '';
            });
            
            delete selectedMaterials['cabinet'];
            delete selectedMaterials['doorPanel'];
            delete selectedMaterials['hinge'];
            delete selectedMaterials['handle'];
            delete selectedMaterials['slide'];
            delete selectedMaterials['glass'];
            delete selectedMaterials['column'];
            delete selectedMaterials['lighting'];
        }

        // æ¸…ç©ºå¢™æ¿è¾“å…¥
        function clearWallpanelInputs() {
            ['wallpanelName', 'wallpanelHeight', 'wallpanelWidth', 'wallpanelColumnLength', 'wallpanelLightingLength'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = '';
            });
            
            // æ¸…ç©ºææ–™é€‰æ‹©
            ['wallpanelMaterialSearch', 'wallpanelColumnMaterialSearch', 'wallpanelLightingMaterialSearch'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = '';
            });
            
            delete selectedMaterials['wallpanel'];
            delete selectedMaterials['column'];
            delete selectedMaterials['lighting'];
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInputs(type) {
            const nameInput = document.getElementById(type + 'Name');
            const searchInput = document.getElementById(type + 'MaterialSearch');
            
            if (nameInput) nameInput.value = '';
            if (searchInput) searchInput.value = '';
            
            // æ¸…ç©ºå°ºå¯¸è¾“å…¥
            switch (type) {
                case 'wallpanel':
                    ['wallpanelHeight', 'wallpanelWidth'].forEach(id => {
                        const input = document.getElementById(id);
                        if (input) input.value = '';
                    });
                    break;
                case 'door':
                    const doorQuantity = document.getElementById('doorQuantity');
                    if (doorQuantity) doorQuantity.value = '1';
                    break;
                case 'column':
                    const columnLength = document.getElementById('columnLength');
                    if (columnLength) columnLength.value = '';
                    break;
                case 'lighting':
                    const lightingLength = document.getElementById('lightingLength');
                    if (lightingLength) lightingLength.value = '';
                    break;
                case 'stone':
                    const stoneArea = document.getElementById('stoneArea');
                    if (stoneArea) stoneArea.value = '';
                    break;
                case 'island':
                    const islandLength = document.getElementById('islandLength');
                    if (islandLength) islandLength.value = '';
                    break;
                case 'baseboard':
                    const baseboardLength = document.getElementById('baseboardLength');
                    if (baseboardLength) baseboardLength.value = '';
                    break;
            }
            
            // æ¸…ç©ºé€‰ä¸­çš„ææ–™
            delete selectedMaterials[type];
        }

        // åˆ é™¤é¡¹ç›®
        function removeItem(id) {
            quoteItems = quoteItems.filter(item => item.id !== id);
            updateQuoteTable();
        }

        // æ¸…ç©ºæ‰€æœ‰é¡¹ç›®
        function clearAllItems() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é¡¹ç›®å—ï¼Ÿ')) {
                quoteItems = [];
                updateQuoteTable();
            }
        }

        // æ›´æ–°æŠ¥ä»·è¡¨æ ¼
        function updateQuoteTable() {
            const tbody = document.getElementById('quoteBody');
            if (!tbody) {
                console.error('æ‰¾ä¸åˆ°æŠ¥ä»·è¡¨æ ¼ä½“');
                return;
            }
            
            tbody.innerHTML = '';
            let total = 0;
            
            quoteItems.forEach((item, index) => {
                total += item.subtotal;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <strong>${item.name}</strong>
                        ${item.details ? `<br><small style="color: var(--secondary-text);">${item.details}</small>` : ''}
                    </td>
                    <td>${item.type}</td>
                    <td><span style="color: var(--accent-blue); font-weight: 500;">${item.material}</span></td>
                    <td>${item.quantity}</td>
                    <td>Â¥${item.unitPrice.toFixed(2)}</td>
                    <td>Â¥${item.subtotal.toFixed(2)}</td>
                    <td>
                        <button class="btn-danger btn-small" onclick="removeItem(${item.id})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // æ·»åŠ æ€»è®¡è¡Œ
            if (quoteItems.length > 0) {
                const totalRow = document.createElement('tr');
                totalRow.className = 'total-row';
                totalRow.innerHTML = `
                    <td colspan="6"><strong>æ€»è®¡</strong></td>
                    <td><strong>Â¥${total.toFixed(2)}</strong></td>
                    <td></td>
                `;
                tbody.appendChild(totalRow);
            }
            
            // æ›´æ–°æ€»è®¡
            const totalElement = document.getElementById('totalAmount');
            if (totalElement) {
                totalElement.textContent = total.toFixed(2);
            }
            
            console.log('æŠ¥ä»·è¡¨æ ¼æ›´æ–°å®Œæˆï¼Œæ€»é‡‘é¢:', total);
        }

        // å¯¼å‡ºExcel
        function exportToExcel() {
            if (quoteItems.length === 0) {
                alert('æŠ¥ä»·æ¸…å•ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡ºï¼');
                return;
            }

            // åˆ›å»ºExcelæ•°æ®
            const excelData = [];
            
            // æ·»åŠ æ ‡é¢˜è¡Œ
            excelData.push(['ä¹å±±å®¶å…·å®šåˆ¶æŠ¥ä»·æ¸…å• - MongoDBé«˜çº§ç®—æ³•ç‰ˆ']);
            excelData.push(['ç”Ÿæˆæ—¶é—´ï¼š' + new Date().toLocaleString('zh-CN')]);
            excelData.push([]); // ç©ºè¡Œ
            
            // æ·»åŠ è¡¨å¤´
            excelData.push(['åºå·', 'ç©ºé—´äº§å“å', 'ç±»å‹', 'æè´¨è§„æ ¼', 'æ•°é‡/é¢ç§¯', 'å•ä»·(å…ƒ)', 'å°è®¡(å…ƒ)', 'è¯¦ç»†è¯´æ˜']);
            
            // æ·»åŠ æ•°æ®è¡Œ
            let total = 0;
            quoteItems.forEach((item, index) => {
                total += item.subtotal;
                excelData.push([
                    index + 1,
                    item.name,
                    item.type,
                    item.material,
                    item.quantity,
                    item.unitPrice.toFixed(2),
                    item.subtotal.toFixed(2),
                    item.details || ''
                ]);
            });
            
            // æ·»åŠ æ€»è®¡è¡Œ
            excelData.push([]);
            excelData.push(['æ€»è®¡é‡‘é¢', '', '', '', '', '', total.toFixed(2), '']);
            
            // è½¬æ¢ä¸ºCSVæ ¼å¼
            const csvContent = excelData.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            
            // åˆ›å»ºBlobå¹¶ä¸‹è½½
            const blob = new Blob(['\uFEFF' + csvContent], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ä¹å±±å®¶å…·å®šåˆ¶æŠ¥ä»·å•_é«˜çº§ç®—æ³•ç‰ˆ_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('Excelå¯¼å‡ºå®Œæˆ');
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—ä¸‹æ‹‰èœå•
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.material-selector')) {
                hideAllMaterialDropdowns();
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œç³»ç»Ÿåˆå§‹åŒ–...');
            await loadMaterialsFromMongoDB(); // åœ¨è¿™é‡ŒåŠ è½½ææ–™
            updateQuoteTable();
            
            // åˆå§‹åŒ–é”®ç›˜æ”¯æŒ
            addKeyboardSupport();
            
            console.log('ä¹å±±å®¶å…·å®šåˆ¶æŠ¥ä»·ç³»ç»ŸMongoDBé«˜çº§ç®—æ³•ç‰ˆåˆå§‹åŒ–å®Œæˆï¼');
            
            // æ·»åŠ æ¸å…¥åŠ¨ç”»
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.animation = 'fadeInUp 0.6s ease-out forwards';
                    }
                });
            }, observerOptions);
            
            document.querySelectorAll('.fade-in').forEach(el => {
                observer.observe(el);
            });
        });
    </script>
</body>
</html>
